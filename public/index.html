<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#F2F2F7">
  <title>Sauki Data</title>
  <style>
    /* iOS Modern Variables */
    :root { 
      --bg: #F2F2F7; 
      --card: rgba(255, 255, 255, 0.9);
      --text: #000000; 
      --sub: #8E8E93;
      --blue: #007AFF; 
      --green: #34C759; 
      --red: #FF3B30;
      --radius: 20px;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif; 
      background: var(--bg); color: var(--text); margin: 0; padding: 0; 
      min-height: 100vh; display: flex; justify-content: center;
      -webkit-font-smoothing: antialiased;
    }

    .app { 
      width: 100%; max-width: 480px; background: var(--bg); min-height: 100vh; 
      position: relative; padding-bottom: 40px; overflow-x: hidden;
    }

    /* Views Transition */
    .view { 
      display: none; padding: 20px; padding-top: 10px; animation: fadeIn 0.3s ease; 
    }
    .view.active { display: block; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

    /* Top Bars */
    .status-bar {
      position: sticky; top: 0; z-index: 1000;
      background: rgba(242, 242, 247, 0.85);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      padding: 10px 20px; padding-top: max(10px, env(safe-area-inset-top));
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
    }
    
    .status-title { font-size: 14px; font-weight: 600; display: flex; flex-direction: column; }
    .contact-icons { display: flex; gap: 12px; }
    .icon-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; transition: transform 0.1s; }
    .icon-btn:active { transform: scale(0.9); }

    /* Navigation Bar */
    .nav-header { display: flex; align-items: center; margin-bottom: 20px; }
    .back-btn { background: none; border: none; font-size: 17px; color: var(--blue); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 0; margin-right: 15px; }
    .page-title { font-size: 28px; font-weight: 700; flex-grow: 1; }

    /* Login Screen */
    #view-login { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; text-align: center; }
    .logo { width: 110px; height: 110px; border-radius: 26px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); object-fit: cover; margin-bottom: 20px; }
    
    .cert-section { margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .cert-text { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--sub); letter-spacing: 0.5px; }
    .cert-logos { display: flex; gap: 15px; align-items: center; justify-content: center; }
    .cert-img { height: 35px; width: auto; }

    /* Wallet Card */
    .wallet-card { 
      background: linear-gradient(135deg, #007AFF, #00C6FF); color: white; padding: 24px; 
      border-radius: 22px; margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,122,255,0.35); 
      position: relative; overflow: hidden;
    }
    .wallet-balance { font-size: 38px; font-weight: 700; letter-spacing: -1px; margin-bottom: 20px; }
    .acc-details { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; }
    .copy-pill { background: #fff; color: var(--blue); font-size: 11px; font-weight: 700; padding: 6px 12px; border-radius: 20px; cursor: pointer; }

    /* Action Buttons Grid */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .net-card { background: #fff; padding: 20px; border-radius: 20px; text-align: center; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.1s; }
    .net-card:active { transform: scale(0.95); }
    .net-logo { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 10px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 14px;}

    /* History List */
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    .hist-item { background: #fff; padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
    .hist-left { display: flex; flex-direction: column; gap: 4px; }
    .hist-title { font-weight: 600; font-size: 15px; }
    .hist-date { font-size: 12px; color: var(--sub); }
    .hist-amount { font-weight: 700; }
    .hist-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; font-weight: 700; width: fit-content; }
    .status-success { background: #d4edda; color: #155724; }
    .status-credit { background: #cce5ff; color: #004085; }
    .status-failed { background: #f8d7da; color: #721c24; }

    /* Success & Failure Screens */
    .result-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 20px; color: white; }
    .success-bg { background: var(--green); box-shadow: 0 10px 30px rgba(52, 199, 89, 0.4); }
    .fail-bg { background: var(--red); box-shadow: 0 10px 30px rgba(255, 59, 48, 0.4); }
    
    .detail-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    .detail-label { color: var(--sub); }
    .detail-val { font-weight: 600; }

    /* Inputs & Buttons */
    .input { width: 100%; padding: 18px; background: #fff; border: none; border-radius: 16px; font-size: 17px; box-sizing: border-box; outline: none; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
    .btn { width: 100%; padding: 18px; background: var(--blue); color: #fff; border: none; border-radius: 16px; font-size: 17px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 20px rgba(0,122,255,0.25); }
    .btn-secondary { background: #e5e5ea; color: #000; box-shadow: none; }
    
    /* Footer */
    .footer { margin-top: 40px; text-align: center; font-size: 11px; color: var(--sub); padding-bottom: 20px; line-height: 1.5; }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: none; align-items: flex-end; z-index: 2000; }
    .modal-content { background: #fff; width: 100%; border-radius: 30px 30px 0 0; padding: 30px 24px; animation: slideUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; overflow-y: auto; }
    @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }
    
    .spinner { width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display:inline-block; vertical-align: middle; }
    @keyframes spin { to {transform: rotate(360deg)} }
  </style>
</head>
<body>

<div class="app">

  <!-- TOP STATUS BAR (Persistent) -->
  <div class="status-bar">
    <div class="status-title">
      <span style="color:var(--blue)">Sauki Data</span>
      <span style="font-size:10px; color:var(--sub)">saukidatalinks@gmail.com</span>
    </div>
    <div class="contact-icons">
      <!-- Phone -->
      <a href="tel:08164135836" class="icon-btn" style="color:#34C759">üìû</a>
      <!-- WhatsApp -->
      <a href="https://wa.me/2348164135836" target="_blank" class="icon-btn" style="color:#25D366">üí¨</a>
    </div>
  </div>
  
  <!-- VIEW 1: AUTH -->
  <div id="view-login" class="view active">
    <img src="logo.jpg" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/100'">
    <h2 style="margin:0; font-size:28px;">Sauki Data</h2>
    <p style="color:var(--sub); margin:5px 0 20px;">Secure. Fast. Automated.</p>
    
    <!-- SMEDAN & COAT OF ARMS -->
    <div class="cert-section">
        <div class="cert-text">Government Certified Business by SMEDAN</div>
        <div class="cert-logos">
            <img src="smedan.png" class="cert-img" onerror="this.style.display='none'">
            <img src="coat.png" class="cert-img" onerror="this.style.display='none'">
        </div>
    </div>

    <div id="step-1">
      <input type="tel" id="login-phone" class="input" placeholder="Phone Number (e.g. 081...)" style="text-align:center">
      <button class="btn" onclick="checkUser()">Continue</button>
    </div>

    <div id="step-2" style="display:none">
      <!-- REGULATORY WARNING -->
      <div id="reg-fields" style="display:none; text-align:left; background:#fff3cd; padding:15px; border-radius:12px; font-size:13px; color:#856404; margin-bottom:15px; line-height: 1.4;">
        <b>In line with Nigerian regulatory requirements, a valid BVN is mandatory for account creation.</b><br><br>
        Your BVN is transmitted securely and encrypted directly to Sterling Bank/Flutterwave's servers for the automatic setup of your funding account. <b>Sauki Data neither receives nor stores your BVN at any time.</b>
        <input type="text" id="login-bvn" class="input" placeholder="Enter BVN or NIN" maxlength="11" style="margin-top:10px; border:1px solid #ddd">
      </div>

      <input type="password" id="login-pin" class="input" placeholder="Enter 4-digit PIN" maxlength="4" style="text-align:center; letter-spacing:8px; font-weight:700;">
      <button class="btn" onclick="authAction()" id="auth-btn">Verify PIN</button>
      <button onclick="location.reload()" style="margin-top:15px; border:none; background:none; color:var(--sub)">Cancel</button>
    </div>
    
    <div class="footer">
        Sauki Data Links copyright<br>
        Developed with ‚ù§Ô∏è from Abdallah Nangere
    </div>
  </div>

  <!-- VIEW 2: DASHBOARD -->
  <div id="view-dashboard" class="view">
    <div class="wallet-card" id="wallet-card">
        <div style="font-size:13px; opacity:0.9">Total Balance</div>
        <div class="wallet-balance" id="dash-bal">‚Ç¶0.00</div>
        <div class="acc-details">
            <div>
                <div style="font-size:10px; text-transform:uppercase;">Dedicated Account</div>
                <div style="font-family:monospace; font-size:18px; font-weight:600" id="dash-acc">...</div>
                <div style="font-size:11px" id="dash-bank">Sterling Bank</div>
            </div>
            <div class="copy-pill" onclick="copyAcc()">COPY</div>
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
        <div class="page-title" style="font-size:20px">Buy Data</div>
        <button onclick="showHistory()" style="background:#fff; border:none; color:var(--blue); font-weight:600; padding:8px 15px; border-radius:20px; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.05)">History üïí</button>
    </div>

    <div class="grid">
      <div class="net-card" onclick="openPlans('mtn')">
        <div class="net-logo" style="background:#FFCC00; color:#000">MTN</div>
        <div style="font-weight:600">MTN Data</div>
      </div>
      <div class="net-card" onclick="openPlans('glo')">
        <div class="net-logo" style="background:#34C759">GLO</div>
        <div style="font-weight:600">Glo Data</div>
      </div>
      <div class="net-card" onclick="openPlans('airtel')">
        <div class="net-logo" style="background:#FF3B30">AIR</div>
        <div style="font-weight:600">Airtel Data</div>
      </div>
      <div class="net-card" onclick="openPlans('9mobile')">
        <div class="net-logo" style="background:#007AFF">9M</div>
        <div style="font-weight:600">9mobile</div>
      </div>
    </div>

    <button onclick="location.reload()" style="margin-top:40px; background:none; border:none; color:var(--red); width:100%; font-weight:600">Log Out</button>
    
    <div class="footer">
        Sauki Data Links copyright<br>
        Developed with ‚ù§Ô∏è from Abdallah Nangere
    </div>
  </div>

  <!-- VIEW 3: SUCCESS SCREEN -->
  <div id="view-success" class="view" style="text-align:center; padding-top:40px;">
    <div class="result-icon success-bg">‚úì</div>
    <h2 style="margin-bottom:5px">Data Purchase Successful</h2>
    <p style="color:var(--sub); margin-bottom:30px">Your data has been sent.</p>

    <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:30px; box-shadow:var(--shadow)">
        <div class="detail-row">
            <span class="detail-label">Beneficiary Number</span>
            <span class="detail-val" id="succ-phone">...</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Package</span>
            <span class="detail-val" id="succ-plan">...</span>
        </div>
        <div class="detail-row" style="border:none">
            <span class="detail-label">Amount Paid</span>
            <span class="detail-val" id="succ-amt">...</span>
        </div>
    </div>

    <button onclick="switchView('view-dashboard')" class="btn">Done</button>
    <button onclick="switchView('view-dashboard')" style="margin-top:15px; background:none; border:none; color:var(--sub)">Back to Home</button>
  </div>

  <!-- VIEW 4: FAILURE SCREEN -->
  <div id="view-fail" class="view" style="text-align:center; padding-top:40px;">
    <div class="result-icon fail-bg">‚úï</div>
    <h2 style="margin-bottom:5px">Transaction Failed</h2>
    <p style="color:var(--sub); margin-bottom:30px" id="fail-reason">Something went wrong.</p>

    <button onclick="switchView('view-dashboard')" class="btn">Try Again</button>
    <button onclick="switchView('view-dashboard')" style="margin-top:15px; background:none; border:none; color:var(--sub)">Back to Home</button>
  </div>

  <!-- VIEW 5: HISTORY -->
  <div id="view-history" class="view">
    <div class="nav-header">
        <button class="back-btn" onclick="switchView('view-dashboard')">‚Äπ Back</button>
        <div class="page-title">Transactions</div>
    </div>
    <div id="history-container" class="history-list">
        <div style="text-align:center; padding:40px; color:var(--sub)">Loading...</div>
    </div>
  </div>

</div>

<!-- TOAST -->
<div id="toast" style="visibility:hidden; background:#333; color:#fff; padding:15px; border-radius:50px; position:fixed; bottom:40px; left:50%; transform:translateX(-50%); z-index:3000">Msg</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content" id="modal-body"></div>
</div>

<script>
  let USER = null;
  let MODE = 'login';
  let SELECTED_PLAN = null;
  let balanceInterval = null;

  // Navigation Logic
  function switchView(viewId) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
    window.scrollTo(0,0);
    
    // Resume/Pause Balance Check
    if(viewId === 'view-dashboard') {
        refreshBalance(false);
        if(!balanceInterval) balanceInterval = setInterval(() => refreshBalance(false), 6000);
    } else {
        if(balanceInterval) clearInterval(balanceInterval);
        balanceInterval = null;
    }
  }

  // --- AUTH FUNCTIONS ---
  async function checkUser() {
    const phone = document.getElementById('login-phone').value.trim();
    if(phone.length < 10) return alert("Invalid Phone");
    
    const btn = document.querySelector('#step-1 button');
    btn.innerText = 'Checking...'; btn.disabled = true;
    
    try {
      const res = await fetch(`/api/user?phone=${phone}`);
      const data = await res.json();
      document.getElementById('step-1').style.display = 'none';
      document.getElementById('step-2').style.display = 'block';
      if(data.exists) {
        MODE = 'login';
        document.getElementById('auth-btn').innerText = "Login";
      } else {
        MODE = 'register';
        document.getElementById('auth-btn').innerText = "Create Account";
        document.getElementById('reg-fields').style.display = 'block'; 
      }
    } catch(e) { alert("Connection Error"); btn.innerText = 'Continue'; btn.disabled = false; }
  }

  async function authAction() {
    const phone = document.getElementById('login-phone').value.trim();
    const pin = document.getElementById('login-pin').value.trim();
    const bvn = document.getElementById('login-bvn').value.trim();
    
    const btn = document.getElementById('auth-btn');
    const oldText = btn.innerText;
    btn.innerText = 'Verifying...'; btn.disabled = true;

    try {
      const res = await fetch('/api/user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ action: MODE, phone, pin, bvn: MODE==='register'?bvn:undefined })
      });
      const data = await res.json();
      if(data.error) throw new Error(data.error);
      
      if(MODE === 'register') { alert("Account Created! Login now."); location.reload(); return; }

      USER = data.data;
      USER.pin = pin; 
      
      // Setup Dashboard
      document.getElementById('dash-bal').innerText = `‚Ç¶${Number(USER.balance).toLocaleString()}`;
      document.getElementById('dash-acc').innerText = USER.account_number || "Generating...";
      document.getElementById('dash-bank').innerText = USER.bank_name || "";
      
      switchView('view-dashboard');

    } catch(e) { alert(e.message); btn.innerText = oldText; btn.disabled = false; }
  }

  async function refreshBalance() {
    if(!USER) return;
    try {
        const res = await fetch(`/api/user?phone=${USER.phone}`);
        const data = await res.json();
        if(data.exists) {
            USER.balance = data.user.wallet_balance;
            document.getElementById('dash-bal').innerText = `‚Ç¶${Number(USER.balance).toLocaleString()}`;
        }
    } catch(e){}
  }

  // --- PURCHASE LOGIC ---
  async function openPlans(net) {
    showModal("Loading...", `<div style="text-align:center; padding:30px"><div class="spinner"></div></div>`);
    try {
        const res = await fetch(`/api/plans?network=${net}`);
        const plans = await res.json();
        let html = `<h3 style="margin-top:0">${net.toUpperCase()} Plans</h3><div style="display:grid; gap:10px; max-height:60vh; overflow-y:auto">`;
        if(plans.length === 0) html += `<p>No plans available.</p>`;
        plans.forEach(p => {
             html += `<div onclick="confirmPlan('${p.id}', ${p.price}, '${p.name}', '${net}')" style="background:#f5f5f7; padding:15px; border-radius:12px; display:flex; justify-content:space-between; cursor:pointer"><b>${p.name}</b><span style="color:#007AFF">‚Ç¶${p.price}</span></div>`;
        });
        html += `</div><button onclick="closeModal()" class="btn btn-secondary" style="margin-top:20px">Close</button>`;
        showModal("", html);
    } catch(e) { showModal("Error", "Failed to load."); }
  }

  function confirmPlan(id, price, name, net) {
    SELECTED_PLAN = { id, price, name, net };
    showModal("", `
        <h3 style="margin-top:0">Confirm Order</h3>
        <div style="background:#f5f5f7; padding:20px; border-radius:16px; text-align:center; margin-bottom:20px">
            <div style="font-size:30px; font-weight:700">‚Ç¶${price}</div>
            <div style="color:#888">${net.toUpperCase()} ${name}</div>
        </div>
        <input id="ben-phone" type="tel" class="input" value="${USER.phone}" placeholder="Beneficiary Phone">
        <div style="margin-bottom:20px; display:flex; gap:10px; align-items:center; font-size:14px">
            <input type="checkbox" id="is-ported" style="width:20px; height:20px"> <label for="is-ported">Ported Number?</label>
        </div>
        <button onclick="process()" class="btn" id="pay-btn">Pay Now</button>
        <button onclick="closeModal()" class="btn btn-secondary" style="margin-top:10px">Cancel</button>
    `);
  }

  async function process() {
    const ben = document.getElementById('ben-phone').value;
    const ported = document.getElementById('is-ported').checked;
    if(ben.length < 10) return alert("Invalid Number");

    const btn = document.getElementById('pay-btn');
    btn.innerHTML = '<div class="spinner"></div>'; btn.disabled = true;

    try {
        const res = await fetch('/api/purchase', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone: USER.phone, pin: USER.pin, plan_id: SELECTED_PLAN.id, beneficiary: ben, ported })
        });
        const result = await res.json();
        closeModal();

        if(result.success) {
            // Update User Balance
            USER.balance = result.new_balance;
            // Setup Success Screen
            document.getElementById('succ-phone').innerText = ben;
            document.getElementById('succ-plan').innerText = `${SELECTED_PLAN.net.toUpperCase()} ${SELECTED_PLAN.name}`;
            document.getElementById('succ-amt').innerText = `‚Ç¶${SELECTED_PLAN.price}`;
            switchView('view-success');
        } else {
            document.getElementById('fail-reason').innerText = result.error || "Transaction declined.";
            switchView('view-fail');
        }
    } catch(e) {
        closeModal();
        document.getElementById('fail-reason').innerText = "Network Error. Check connection.";
        switchView('view-fail');
    }
  }

  // --- HISTORY LOGIC ---
  async function showHistory() {
    switchView('view-history');
    const container = document.getElementById('history-container');
    container.innerHTML = '<div style="text-align:center; padding:20px"><div class="spinner" style="border-color:#007AFF; border-top-color:transparent"></div></div>';

    try {
        const res = await fetch(`/api/user?phone=${USER.phone}&type=history`);
        const data = await res.json();

        if(data.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">No transactions yet.</div>';
            return;
        }

        let html = '';
        data.forEach(t => {
            const isCredit = t.status === 'credit';
            const colorClass = isCredit ? 'status-credit' : (t.status === 'success' ? 'status-success' : 'status-failed');
            const date = new Date(t.created_at).toLocaleDateString();
            const title = isCredit ? 'Wallet Funding' : `${t.network || 'Data'} Purchase`;
            const sign = isCredit ? '+' : '-';
            const color = isCredit ? '#34C759' : '#000';
            // Show new_balance or amount
            const amtDisplay = Number(t.amount).toLocaleString();

            html += `
            <div class="hist-item">
                <div class="hist-left">
                    <div class="hist-title">${title}</div>
                    <div class="hist-date">${date}</div>
                    <div class="hist-status ${colorClass}">${t.status}</div>
                </div>
                <div class="hist-amount" style="color:${color}">${sign}‚Ç¶${amtDisplay}</div>
            </div>`;
        });
        container.innerHTML = html;
    } catch(e) {
        container.innerHTML = '<div style="text-align:center; color:red">Failed to load history.</div>';
    }
  }

  function showModal(title, html) {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modal-body').innerHTML = (title?`<h2>${title}</h2>`:'') + html;
  }
  function closeModal() { document.getElementById('modal').style.display = 'none'; }
  function copyAcc() { navigator.clipboard.writeText(USER.account_number); alert("Copied!"); }
</script>
</body>
</html>
