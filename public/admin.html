<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sauki Admin Pro | iOS 26 Concept</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #000000;
            --glass-panel: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --accent-primary: #0A84FF;
            --accent-success: #30D158;
            --accent-danger: #FF453A;
            --accent-warning: #FF9F0A;
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF599;
            --text-tertiary: #EBEBF54D;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 10px;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --shadow-subtle: 0 10px 40px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(10, 132, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(48, 209, 88, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- UTILITIES --- */
        .glass {
            background: var(--glass-panel);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-subtle);
        }
        
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }

        /* --- LAYOUT --- */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            width: 95vw;
            height: 92vh;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- SIDEBAR --- */
        .sidebar {
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            z-index: 10;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), #5E5CE6);
            border-radius: 10px;
            display: grid;
            place-items: center;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--glass-highlight);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent-primary);
        }

        .nav-item i { width: 20px; height: 20px; }

        /* --- MAIN CONTENT --- */
        .main-content {
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }
        
        /* Scrollbar styling */
        .main-content::-webkit-scrollbar { width: 6px; }
        .main-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        h1 { margin: 0; font-size: 2rem; font-weight: 700; letter-spacing: -0.03em; }
        .subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; }

        /* --- CARDS & FORMS --- */
        .card {
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
        }

        input, select, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            font-family: inherit;
            transition: 0.2s;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn:active { transform: scale(0.96); }

        .btn-primary { background: var(--accent-primary); color: white; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3); }
        .btn-primary:hover { background: #0071e3; }

        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: white; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); }

        .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--accent-danger); }
        .btn-danger:hover { background: rgba(255, 69, 58, 0.25); }

        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 8px; }

        /* --- TABLES --- */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }

        table { width: 100%; border-collapse: collapse; }
        
        th {
            text-align: left;
            padding: 16px 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 600;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--glass-highlight); }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        .badge-success { background: rgba(48, 209, 88, 0.15); color: var(--accent-success); }
        .badge-failed { background: rgba(255, 69, 58, 0.15); color: var(--accent-danger); }
        .badge-net { background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); border: 1px solid var(--glass-border); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-box {
            background: #1c1c1e; width: 100%; max-width: 420px;
            border-radius: var(--radius-lg); padding: 30px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        /* --- TOAST --- */
        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 200; display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            padding: 12px 20px; border-radius: 50px; background: rgba(30,30,30,0.9);
            border: 1px solid var(--glass-border); color: white; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideDown { from { opacity:0; transform: translateY(-20px); } to { opacity:1; transform: translateY(0); } }

        /* --- MOBILE --- */
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; width: 100%; height: 100%; border-radius: 0; }
            .sidebar { display: none; position: fixed; inset: 0; background: #000; z-index: 50; padding-top: 80px; }
            .sidebar.active { display: flex; }
            .mobile-nav { display: flex; justify-content: space-between; padding: 20px; align-items: center; }
            .main-content { padding: 20px; padding-top: 10px; }
        }
    </style>
</head>
<body>

    <!-- Toast Host -->
    <div class="toast-container" id="toast-host"></div>

    <!-- Login Modal -->
    <div class="modal-overlay open" id="login-modal" style="z-index: 200;">
        <div class="modal-box glass" style="text-align: center;">
            <div class="brand-icon" style="margin: 0 auto 20px; width: 48px; height: 48px;">
                <i data-lucide="shield-check" color="white"></i>
            </div>
            <h2 style="margin-bottom: 5px;">Welcome Back</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">Authenticate to access the mainframe.</p>
            <input type="text" id="adm-u" placeholder="Admin ID" style="margin-bottom: 10px; text-align: center;">
            <input type="password" id="adm-p" placeholder="Passkey" style="margin-bottom: 20px; text-align: center;">
            <button class="btn btn-primary w-full" onclick="adminLogin()">Unlock Dashboard</button>
        </div>
    </div>

    <!-- Manual Order Modal -->
    <div class="modal-overlay" id="manual-modal">
        <div class="modal-box glass">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3>Manual Dispatch</h3>
                <button class="btn btn-icon btn-secondary" onclick="toggleModal('manual-modal', false)"><i data-lucide="x"></i></button>
            </div>
            <div class="flex flex-col gap-4">
                <input id="m-phone" placeholder="Recipient Phone (080...)">
                <select id="m-net" onchange="updatePlanList()">
                    <option value="mtn">MTN</option>
                    <option value="glo">Glo</option>
                    <option value="airtel">Airtel</option>
                    <option value="9mobile">9mobile</option>
                </select>
                <select id="m-plan"><option>Select Network First...</option></select>
                <button class="btn btn-primary" onclick="sendManual()" style="margin-top: 10px;">
                    <i data-lucide="send"></i> Dispatch Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Plan Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box glass">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 id="form-title">Configure Plan</h3>
                <button class="btn btn-icon btn-secondary" onclick="toggleModal('edit-modal', false)"><i data-lucide="x"></i></button>
            </div>
            <div class="flex flex-col gap-4">
                <input id="p-id" placeholder="Internal ID (e.g. mtn-1gb)">
                <div class="flex gap-2">
                    <select id="p-net"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option></select>
                    <input id="p-price" type="number" placeholder="Price (₦)">
                </div>
                <input id="p-name" placeholder="Display Name (e.g. 1GB SME)">
                <input id="p-api" placeholder="Provider API ID">
                <button class="btn btn-primary" onclick="savePlan()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Main App UI -->
    <div class="app-container glass hidden" id="app-ui">
        <!-- Sidebar -->
        <aside class="sidebar glass" id="sidebar">
            <div class="brand">
                <div class="brand-icon"><i data-lucide="zap" color="white"></i></div>
                <span>Sauki Pro</span>
            </div>
            
            <nav style="flex: 1;">
                <button class="nav-item active" onclick="showTab('plans', this)">
                    <i data-lucide="package"></i> Data Plans
                </button>
                <button class="nav-item" onclick="showTab('tx', this)">
                    <i data-lucide="activity"></i> Transactions
                </button>
                <button class="nav-item" onclick="showTab('complaints', this)">
                    <i data-lucide="message-square-warning"></i> Complaints
                </button>
                <button class="nav-item" onclick="showTab('msg', this)">
                    <i data-lucide="megaphone"></i> Broadcast
                </button>
            </nav>

            <button class="nav-item" onclick="logout()" style="color: var(--accent-danger);">
                <i data-lucide="log-out"></i> Disconnect
            </button>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Mobile Header -->
            <div class="mobile-nav hidden" style="display: none;" id="mobile-header">
                <div class="brand-icon"><i data-lucide="zap" color="white"></i></div>
                <button class="btn btn-icon btn-secondary" onclick="document.getElementById('sidebar').classList.toggle('active')">
                    <i data-lucide="menu"></i>
                </button>
            </div>

            <!-- PLANS TAB -->
            <section id="tab-plans">
                <div class="header">
                    <div>
                        <h1>Plan Management</h1>
                        <div class="subtitle">Configure pricing and API mapping</div>
                    </div>
                    <button class="btn btn-primary" onclick="openEdit()">
                        <i data-lucide="plus"></i> New Plan
                    </button>
                </div>
                
                <div class="table-container glass">
                    <table>
                        <thead>
                            <tr><th>Network</th><th>Name</th><th>Price</th><th>API ID</th><th style="text-align:right">Actions</th></tr>
                        </thead>
                        <tbody id="plans-table"></tbody>
                    </table>
                </div>
            </section>

            <!-- TRANSACTIONS TAB -->
            <section id="tab-tx" class="hidden">
                <div class="header">
                    <div>
                        <h1>Transactions</h1>
                        <div class="subtitle">Live feed of all data processing</div>
                    </div>
                    <div class="flex gap-2">
                         <button class="btn btn-secondary" onclick="openManual()">
                            <i data-lucide="zap"></i> Manual
                        </button>
                         <button class="btn btn-secondary" onclick="exportCsv()">
                            <i data-lucide="download"></i> CSV
                        </button>
                    </div>
                </div>

                <div class="card glass flex gap-2" style="padding: 15px;">
                    <div style="position:relative; flex:1">
                        <i data-lucide="search" style="position:absolute; left:12px; top:12px; color:var(--text-secondary); width:18px;"></i>
                        <input id="search-tx" placeholder="Search reference or phone..." style="padding-left: 40px; border:none; background: rgba(255,255,255,0.05);">
                    </div>
                    <button class="btn btn-primary" onclick="loadTx(true)">Search</button>
                    <button class="btn btn-secondary btn-icon" onclick="loadTx()"><i data-lucide="rotate-ccw"></i></button>
                </div>

                <div class="table-container glass">
                    <table>
                        <thead>
                            <tr><th>Time</th><th>Ref</th><th>Phone</th><th>Plan</th><th>Status</th><th style="text-align:right">Action</th></tr>
                        </thead>
                        <tbody id="tx-table"></tbody>
                    </table>
                </div>
            </section>

            <!-- COMPLAINTS TAB -->
            <section id="tab-complaints" class="hidden">
                <div class="header">
                    <div>
                        <h1>User Reports</h1>
                        <div class="subtitle">Inbox of user submitted issues</div>
                    </div>
                    <button class="btn btn-secondary btn-icon" onclick="loadComplaints()"><i data-lucide="rotate-ccw"></i></button>
                </div>
                <div class="table-container glass">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>User</th><th>Phone</th><th>Message</th><th style="text-align:right">Resolve</th></tr>
                        </thead>
                        <tbody id="complaints-table"></tbody>
                    </table>
                </div>
            </section>

            <!-- BROADCAST TAB -->
            <section id="tab-msg" class="hidden">
                <div class="header">
                    <div>
                        <h1>System Broadcast</h1>
                        <div class="subtitle">Push global announcements to user dashboards</div>
                    </div>
                </div>
                <div class="card glass">
                    <label style="display:block; margin-bottom:10px; color:var(--text-secondary); font-size:0.9rem;">Announcement Message</label>
                    <textarea id="broadcast-input" rows="5" placeholder="Type message here... (Leave empty to disable)"></textarea>
                    <div class="flex justify-between items-center" style="margin-top: 20px;">
                        <span style="font-size:0.8rem; color:var(--text-tertiary);">Visible to all users immediately</span>
                        <button class="btn btn-primary" onclick="saveMessage()">
                            <i data-lucide="save"></i> Publish Update
                        </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        // State
        let authHeader = '';
        let allPlans = [];
        let currentTxData = [];

        // --- UTILS ---
        function toast(msg, type = 'info') {
            const host = document.getElementById('toast-host');
            const el = document.createElement('div');
            el.className = 'toast';
            let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
            let color = type === 'success' ? 'var(--accent-success)' : (type === 'error' ? 'var(--accent-danger)' : 'white');
            
            el.innerHTML = `<i data-lucide="${icon}" style="color:${color}; width:18px;"></i> ${msg}`;
            host.appendChild(el);
            lucide.createIcons();
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-10px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if(show) el.classList.add('open');
            else el.classList.remove('open');
        }

        function renderLoading(cols = 5) {
            return `<tr><td colspan="${cols}" style="text-align:center; padding:40px; color:var(--text-tertiary);">Loading Data...</td></tr>`;
        }

        // --- AUTH ---
        async function adminLogin() {
            const u = document.getElementById('adm-u').value;
            const p = document.getElementById('adm-p').value;
            if(!u || !p) return toast('Please enter credentials', 'error');

            const creds = 'Basic ' + btoa(u + ':' + p);
            try {
                const res = await fetch('/api/admin?action=check', { headers: { 'Authorization': creds } });
                if(res.ok) {
                    authHeader = creds;
                    document.getElementById('login-modal').classList.remove('open');
                    document.getElementById('app-ui').classList.remove('hidden');
                    
                    // Init Data
                    loadPlans();
                    loadMessage();
                    
                    // Check Mobile
                    if(window.innerWidth <= 900) document.getElementById('mobile-header').style.display = 'flex';
                } else { 
                    toast("Access Denied: Invalid Credentials", 'error'); 
                    document.getElementById('adm-p').value = '';
                }
            } catch(e) { toast("Connection Error", 'error'); }
        }

        function logout() {
            authHeader = '';
            document.getElementById('app-ui').classList.add('hidden');
            toggleModal('login-modal', true);
            document.getElementById('adm-u').value = '';
            document.getElementById('adm-p').value = '';
        }

        // --- NAVIGATION ---
        function showTab(t, btn) {
            ['plans', 'tx', 'msg', 'complaints'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            
            // Sidebar Active State
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }

            // Close mobile sidebar if open
            document.getElementById('sidebar').classList.remove('active');

            if(t === 'tx') loadTx();
            if(t === 'complaints') loadComplaints();
        }

        // --- PLANS ---
        function openEdit(plan = null) {
            toggleModal('edit-modal', true);
            const title = document.getElementById('form-title');
            if (plan) {
                title.innerText = "Edit Configuration";
                document.getElementById('p-id').value = plan.id;
                document.getElementById('p-id').readOnly = true; 
                document.getElementById('p-net').value = plan.network;
                document.getElementById('p-name').value = plan.name;
                document.getElementById('p-price').value = plan.price;
                document.getElementById('p-api').value = plan.plan_id_api;
            } else {
                title.innerText = "New Configuration";
                document.getElementById('p-id').value = "";
                document.getElementById('p-id').readOnly = false;
                document.getElementById('p-name').value = "";
                document.getElementById('p-price').value = "";
                document.getElementById('p-api').value = "";
            }
        }

        async function loadPlans() {
            document.getElementById('plans-table').innerHTML = renderLoading();
            try {
                const res = await fetch('/api/plans');
                allPlans = await res.json();
                const rows = allPlans.map(p => `
                    <tr>
                    <td><span class="badge badge-net">${p.network.toUpperCase()}</span></td>
                    <td style="font-weight:500">${p.name}</td>
                    <td>₦${p.price}</td>
                    <td style="font-family:monospace; color:var(--text-secondary)">${p.plan_id_api}</td>
                    <td style="text-align:right">
                        <button class="btn btn-secondary" style="padding:6px 12px; font-size:0.8rem" onclick='openEdit(${JSON.stringify(p)})'>Edit</button>
                        <button class="btn btn-danger" style="padding:6px 12px; font-size:0.8rem" onclick="deletePlan('${p.id}')">×</button>
                    </td>
                    </tr>
                `).join('');
                document.getElementById('plans-table').innerHTML = rows;
            } catch(e) { console.error(e); }
        }

        async function savePlan() {
            const body = {
                action: 'create', 
                id: document.getElementById('p-id').value,
                network: document.getElementById('p-net').value,
                name: document.getElementById('p-name').value,
                price: document.getElementById('p-price').value,
                plan_id_api: document.getElementById('p-api').value
            };
            await fetch('/api/plans', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify(body) });
            toggleModal('edit-modal', false);
            toast('Plan Configuration Saved', 'success');
            loadPlans();
        }

        async function deletePlan(id) {
            if(!confirm("Are you sure you want to delete this plan?")) return;
            await fetch('/api/plans', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'delete', id }) });
            loadPlans();
            toast('Plan Deleted', 'success');
        }

        // --- TRANSACTIONS ---
        async function loadTx(isSearch = false) {
            const tbody = document.getElementById('tx-table');
            tbody.innerHTML = renderLoading(6);
            
            let url = '/api/admin?action=transactions';
            if(isSearch) {
                const q = document.getElementById('search-tx').value;
                if(q) url += `&search=${encodeURIComponent(q)}`;
            }
            
            try {
                const res = await fetch(url, { headers: { 'Authorization': authHeader } });
                const data = await res.json();
                if(data.error) return toast(data.error, 'error');
                
                currentTxData = data; 

                const rows = data.map(t => {
                    const isSuccess = t.status === 'success';
                    const badgeClass = isSuccess ? 'badge-success' : 'badge-failed';
                    const retryBtn = !isSuccess ? `<button class="btn btn-secondary" style="padding:4px 10px; font-size:0.75rem" onclick="retryTx('${t.id}')">Retry</button>` : '';
                    
                    return `
                        <tr>
                            <td style="font-size:0.8rem; color:var(--text-secondary)">${new Date(t.created_at).toLocaleString()}</td>
                            <td style="font-family:monospace; font-size:0.8rem">${t.reference}</td>
                            <td>${t.phone_number}</td>
                            <td>${t.plan_id}</td>
                            <td><span class="badge ${badgeClass}">${t.status}</span></td>
                            <td style="text-align:right">${retryBtn}</td>
                        </tr>`;
                }).join('');
                tbody.innerHTML = rows.length ? rows : '<tr><td colspan="6" style="text-align:center; padding:30px">No transactions found</td></tr>';
            } catch(e) { tbody.innerHTML = '<tr><td colspan="6">Error loading data</td></tr>'; }
        }

        async function retryTx(id) {
            if(!confirm("Retry this transaction?")) return;
            const res = await fetch('/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'retry', id: id }) });
            const data = await res.json();
            if(data.success) { toast('Retry Initiated', 'success'); loadTx(); }
            else toast('Retry Failed: ' + data.error, 'error');
        }
        
        function exportCsv() {
            if(!currentTxData.length) return toast("No data to export", 'info');
            const headers = ["Date", "Reference", "Phone", "Plan", "Status", "Network"];
            const rows = currentTxData.map(t => [
                new Date(t.created_at).toLocaleString().replace(/,/g, ''),
                t.reference,
                t.phone_number,
                t.plan_id,
                t.status,
                t.network
            ]);
            
            let csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "sauki_transactions.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- COMPLAINTS ---
        async function loadComplaints() {
            const tbody = document.getElementById('complaints-table');
            tbody.innerHTML = renderLoading();
            
            const res = await fetch('/api/admin?action=complaints', { headers: { 'Authorization': authHeader } });
            const data = await res.json();
            const rows = data.map(c => `
                <tr>
                    <td style="font-size:0.8rem; color:var(--text-secondary)">${new Date(c.created_at).toLocaleDateString()}</td>
                    <td>${c.name || 'Anonymous'}</td>
                    <td><a href="tel:${c.phone}" style="color:var(--accent-primary); text-decoration:none">${c.phone}</a></td>
                    <td style="max-width:300px; white-space:pre-wrap; color:var(--text-secondary)">${c.message}</td>
                    <td style="text-align:right">
                        <button class="btn btn-danger" style="padding:6px 12px; font-size:0.75rem" onclick="deleteComplaint('${c.id}')">Resolve</button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = rows.length ? rows : '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-tertiary)">All caught up! No complaints.</td></tr>';
        }

        async function deleteComplaint(id) {
            if(!confirm("Mark resolved?")) return;
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
                body: JSON.stringify({ action: 'delete_complaint', id })
            });
            loadComplaints();
            toast('Complaint Resolved', 'success');
        }

        // --- BROADCAST & MANUAL ---
        async function loadMessage() {
            const res = await fetch('/api/status');
            const data = await res.json();
            if(data.message) document.getElementById('broadcast-input').value = data.message;
        }

        async function saveMessage() {
            const msg = document.getElementById('broadcast-input').value;
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
                body: JSON.stringify({ action: 'save_message', message: msg })
            });
            toast('Broadcast Updated', 'success');
        }

        function openManual() { toggleModal('manual-modal', true); updatePlanList(); }
        
        function updatePlanList() { 
            const net = document.getElementById('m-net').value; 
            const filtered = allPlans.filter(p => p.network === net); 
            const select = document.getElementById('m-plan');
            if(filtered.length === 0) {
                select.innerHTML = '<option>No plans found</option>';
            } else {
                select.innerHTML = filtered.map(p => `<option value="${p.id}">${p.name} (₦${p.price})</option>`).join('');
            }
        }

        async function sendManual() {
            const phone = document.getElementById('m-phone').value; 
            const net = document.getElementById('m-net').value; 
            const pid = document.getElementById('m-plan').value;
            
            if(!phone || !pid) return toast("Please fill all fields", 'error');
            
            // Simple visual feedback
            const btn = document.querySelector('#manual-modal .btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Dispatching...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'manual', phone, network: net, plan_id: pid }) });
                const d = await res.json();
                
                if(d.success) {
                    toast("Data Dispatched Successfully", 'success');
                    toggleModal('manual-modal', false);
                    if(document.getElementById('tab-tx').style.display !== 'none') loadTx();
                } else {
                    toast("Failed: " + d.error, 'error');
                }
            } catch(e) { toast("Connection Error", 'error'); }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    </script>
</body>
</html>
