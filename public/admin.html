<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sauki Admin Pro</title>
  <style>
    :root { --admin-bg: #1e1e2d; --admin-panel: #2b2b40; --accent: #3699ff; --text: #e1e1e6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--admin-bg); color: var(--text); margin: 0; padding: 20px; }
    
    .dashboard-grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
    @media(max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

    .sidebar { background: var(--admin-panel); padding: 20px; border-radius: 12px; height: fit-content; }
    .main { background: var(--admin-panel); padding: 30px; border-radius: 12px; min-height: 80vh; }

    h2, h3 { margin-top: 0; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    
    input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #151521; border: 1px solid #444; color: #fff; border-radius: 6px; }
    
    button { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--accent); color: #fff; width: 100%; }
    .btn-danger { background: #f64e60; color: #fff; }
    .btn-edit { background: #FFA800; color: #000; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
    .btn-success { background: #1dc9b7; color: #fff; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
    th { text-align: left; padding: 15px; background: rgba(0,0,0,0.3); color: #888; }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase; }
    .s-success { background: rgba(29, 201, 183, 0.2); color: #1dc9b7; }
    .s-failed { background: rgba(253, 57, 122, 0.2); color: #fd397a; }

    #login-modal, #manual-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
    .login-box { background: var(--admin-panel); padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div id="login-modal" style="display:flex">
    <div class="login-box">
      <h2>Admin Login</h2>
      <input type="text" id="adm-u" placeholder="Admin Username">
      <input type="password" id="adm-p" placeholder="Password">
      <button class="btn-primary" onclick="adminLogin()">Access Dashboard</button>
    </div>
  </div>

  <!-- Manual Order Modal -->
  <div id="manual-modal">
    <div class="login-box">
      <h3>Manual Order</h3>
      <input id="m-phone" placeholder="Phone Number (080...)">
      <select id="m-net" onchange="updatePlanList()"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option></select>
      <select id="m-plan"><option>Loading...</option></select>
      <button class="btn-success" onclick="sendManual()" style="margin-top:10px">Send Data</button>
      <button class="btn-danger" onclick="document.getElementById('manual-modal').style.display='none'" style="margin-top:10px">Close</button>
    </div>
  </div>

  <div class="dashboard-grid" id="app-ui" style="display:none">
    <aside class="sidebar">
      <h3>Menu</h3>
      <button class="btn-primary" style="background:transparent; text-align:left" onclick="showTab('plans')">Manage Plans</button>
      <button class="btn-primary" style="background:transparent; text-align:left" onclick="showTab('tx')">Transactions</button>
      <button class="btn-primary" style="background:transparent; text-align:left; color:#f64e60" onclick="showTab('complaints')">Complaints</button>
      <button class="btn-primary" style="background:transparent; text-align:left; color:#FFA800" onclick="showTab('msg')">Broadcast Message</button>
      <div style="margin-top:40px; border-top:1px solid #444; padding-top:20px;">
        <button class="btn-danger" onclick="location.reload()">Logout</button>
      </div>
    </aside>

    <!-- PLANS TAB -->
    <main class="main" id="tab-plans">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Data Plans</h2>
        <button class="btn-primary" style="width:auto" onclick="openEdit()">+ Add New Plan</button>
      </div>

      <div id="edit-form" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:8px; margin-bottom:20px; display:none;">
        <h4 style="margin-top:0" id="form-title">Plan Details</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="p-id" placeholder="ID (e.g. mtn-1gb)">
          <select id="p-net"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option></select>
          <input id="p-name" placeholder="Display Name (e.g. 1GB SME)">
          <input id="p-price" type="number" placeholder="Price (₦)">
          <input id="p-api" placeholder="Amigo/API Plan ID">
        </div>
        <button class="btn-primary" style="margin-top:10px;" onclick="savePlan()">Save Plan</button>
      </div>

      <table>
        <thead><tr><th>Network</th><th>Name</th><th>Price</th><th>API ID</th><th>Action</th></tr></thead>
        <tbody id="plans-table"></tbody>
      </table>
    </main>

    <!-- TRANSACTIONS TAB -->
    <main class="main" id="tab-tx" style="display:none">
      <div style="display:flex; justify-content:space-between;">
        <h2>Recent Transactions</h2>
        <div>
           <button class="btn-success" onclick="openManual()">+ Manual Order</button>
           <button onclick="loadTx()" style="background:#444; color:#fff; padding:8px 15px; border-radius:6px; border:none">Refresh</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Ref</th><th>Phone</th><th>Plan</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="tx-table"></tbody>
      </table>
    </main>

    <!-- COMPLAINTS TAB (NEW) -->
    <main class="main" id="tab-complaints" style="display:none">
        <div style="display:flex; justify-content:space-between;">
            <h2>User Complaints</h2>
            <button onclick="loadComplaints()" style="background:#444; color:#fff; padding:8px 15px; border-radius:6px; border:none">Refresh</button>
        </div>
        <table>
            <thead><tr><th>Time</th><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr></thead>
            <tbody id="complaints-table"></tbody>
        </table>
    </main>

    <!-- MESSAGE TAB -->
    <main class="main" id="tab-msg" style="display:none">
        <h2>System Broadcast</h2>
        <p style="color:#888">This message will appear at the top of the user's home screen. Leave empty to disable.</p>
        <textarea id="broadcast-input" rows="4" placeholder="e.g., MTN Network is currently unstable. Please expect delays."></textarea>
        <button class="btn-primary" onclick="saveMessage()">Update Message</button>
    </main>
  </div>

  <script>
    let authHeader = '';
    let allPlans = [];

    async function adminLogin() {
      const u = document.getElementById('adm-u').value;
      const p = document.getElementById('adm-p').value;
      const creds = 'Basic ' + btoa(u + ':' + p);
      try {
        const res = await fetch('/api/admin?action=check', { headers: { 'Authorization': creds } });
        if(res.ok) {
          authHeader = creds;
          document.getElementById('login-modal').style.display = 'none';
          document.getElementById('app-ui').style.display = 'grid';
          loadPlans();
          loadMessage(); 
        } else { alert("Access Denied"); }
      } catch(e) { alert("Connection Error"); }
    }

    function showTab(t) {
      ['plans', 'tx', 'msg', 'complaints'].forEach(x => document.getElementById('tab-'+x).style.display = 'none');
      document.getElementById('tab-' + t).style.display = 'block';
      if(t === 'tx') loadTx();
      if(t === 'complaints') loadComplaints();
    }

    // --- PLANS ---
    function openEdit(plan = null) {
      const f = document.getElementById('edit-form');
      f.style.display = 'block';
      if (plan) {
          document.getElementById('form-title').innerText = "Edit Plan";
          document.getElementById('p-id').value = plan.id;
          document.getElementById('p-id').readOnly = true; 
          document.getElementById('p-net').value = plan.network;
          document.getElementById('p-name').value = plan.name;
          document.getElementById('p-price').value = plan.price;
          document.getElementById('p-api').value = plan.plan_id_api;
      } else {
          document.getElementById('form-title').innerText = "New Plan";
          document.getElementById('p-id').value = "";
          document.getElementById('p-id').readOnly = false;
          document.getElementById('p-name').value = "";
          document.getElementById('p-price').value = "";
          document.getElementById('p-api').value = "";
      }
    }

    async function loadPlans() {
      const res = await fetch('/api/plans');
      allPlans = await res.json();
      const rows = allPlans.map(p => `
        <tr>
          <td style="text-transform:uppercase; font-weight:bold; color:var(--accent)">${p.network}</td>
          <td>${p.name}</td>
          <td>₦${p.price}</td>
          <td>${p.plan_id_api}</td>
          <td>
            <button class="btn-edit" onclick='openEdit(${JSON.stringify(p)})'>Edit</button>
            <button class="btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="deletePlan('${p.id}')">X</button>
          </td>
        </tr>
      `).join('');
      document.getElementById('plans-table').innerHTML = rows;
    }

    async function savePlan() {
      const body = {
        action: 'create', 
        id: document.getElementById('p-id').value,
        network: document.getElementById('p-net').value,
        name: document.getElementById('p-name').value,
        price: document.getElementById('p-price').value,
        plan_id_api: document.getElementById('p-api').value
      };
      await fetch('/api/plans', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify(body) });
      document.getElementById('edit-form').style.display = 'none';
      loadPlans();
    }

    async function deletePlan(id) {
      if(!confirm("Are you sure?")) return;
      await fetch('/api/plans', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'delete', id }) });
      loadPlans();
    }

    // --- TRANSACTIONS ---
    async function loadTx() {
      const res = await fetch('/api/admin?action=transactions', { headers: { 'Authorization': authHeader } });
      const data = await res.json();
      if(data.error) return alert(data.error);

      const rows = data.map(t => {
        const badge = t.status === 'success' ? 's-success' : 's-failed';
        let actionBtn = t.status !== 'success' ? `<button class="btn-retry" style="background:#FFA800; color:black; padding:4px 8px; border-radius:4px" onclick="retryTx('${t.id}')">Retry ↺</button>` : '';
        return `<tr><td style="font-size:0.8rem; color:#888">${new Date(t.created_at).toLocaleString()}</td><td style="font-family:monospace; font-size:0.8rem">${t.reference}</td><td>${t.phone_number}</td><td>${t.plan_id}</td><td><span class="status-badge ${badge}">${t.status}</span></td><td>${actionBtn}</td></tr>`;
      }).join('');
      document.getElementById('tx-table').innerHTML = rows;
    }

    async function retryTx(id) {
        if(!confirm("Retry this transaction?")) return;
        const res = await fetch('/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'retry', id: id }) });
        const data = await res.json();
        alert(data.success ? "Success!" : "Failed: " + data.error);
        loadTx();
    }

    // --- COMPLAINTS (NEW) ---
    async function loadComplaints() {
        const res = await fetch('/api/admin?action=complaints', { headers: { 'Authorization': authHeader } });
        const data = await res.json();
        const rows = data.map(c => `
            <tr>
                <td style="font-size:0.8rem; color:#888">${new Date(c.created_at).toLocaleString()}</td>
                <td>${c.name || 'Anonymous'}</td>
                <td><a href="tel:${c.phone}" style="color:var(--accent); text-decoration:none">${c.phone}</a></td>
                <td style="max-width:300px; word-wrap:break-word;">${c.message}</td>
                <td>
                    <button class="btn-danger" style="padding:4px 8px; font-size:0.75rem" onclick="deleteComplaint('${c.id}')">Resolve / Delete</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('complaints-table').innerHTML = rows.length ? rows : '<tr><td colspan="5" style="text-align:center; padding:20px">No complaints yet</td></tr>';
    }

    async function deleteComplaint(id) {
        if(!confirm("Mark this as resolved and delete?")) return;
        await fetch('/api/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
            body: JSON.stringify({ action: 'delete_complaint', id })
        });
        loadComplaints();
    }

    // --- BROADCAST MESSAGE ---
    async function loadMessage() {
        const res = await fetch('/api/status');
        const data = await res.json();
        if(data.message) document.getElementById('broadcast-input').value = data.message;
    }

    async function saveMessage() {
        const msg = document.getElementById('broadcast-input').value;
        await fetch('/api/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
            body: JSON.stringify({ action: 'save_message', message: msg })
        });
        alert("Message Updated!");
    }

    // --- MANUAL ORDERS ---
    function openManual() { document.getElementById('manual-modal').style.display = 'flex'; updatePlanList(); }
    function updatePlanList() { const net = document.getElementById('m-net').value; const filtered = allPlans.filter(p => p.network === net); document.getElementById('m-plan').innerHTML = filtered.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); }
    async function sendManual() {
        const phone = document.getElementById('m-phone').value; const net = document.getElementById('m-net').value; const pid = document.getElementById('m-plan').value;
        if(!phone || !pid) return alert("Fill all fields");
        if(!confirm(`Send ${net.toUpperCase()} data to ${phone}?`)) return;
        try {
            const res = await fetch('/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify({ action: 'manual', phone, network: net, plan_id: pid }) });
            const d = await res.json();
            alert(d.success ? "Sent Successfully!" : "Failed: " + d.error);
            if(d.success) { document.getElementById('manual-modal').style.display = 'none'; loadTx(); }
        } catch(e) { alert("Error"); }
    }
  </script>
</body>
</html>


