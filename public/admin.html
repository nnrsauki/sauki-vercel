<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sauki Admin</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; }
    input, select { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    button { padding: 10px; background: #007AFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    #login-screen, #dashboard { display: none; }
    .nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .nav-item { cursor: pointer; padding: 5px 10px; font-weight: bold; color: #888; }
    .nav-item.active { color: #007AFF; border-bottom: 2px solid #007AFF; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .fund-btn { background: #28a745; margin-left: 10px; font-size: 12px; padding: 5px 10px; }
  </style>
</head>
<body>

<div id="login-screen" class="container" style="max-width:400px; text-align:center; display:block;">
  <h2>Admin Login</h2>
  <input type="text" id="u" placeholder="Username">
  <input type="password" id="p" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="dashboard" class="container">
  <div style="display:flex; justify-content:space-between;">
    <h2>Sauki Admin</h2>
    <button onclick="location.reload()" style="background:#333">Logout</button>
  </div>
  
  <div class="nav">
    <div class="nav-item active" onclick="switchTab('plans')" id="tab-plans">Plans</div>
    <div class="nav-item" onclick="switchTab('users')" id="tab-users">Users</div>
  </div>

  <!-- PLANS VIEW -->
  <div id="view-plans">
    <div style="background:#f9f9f9; padding:15px; margin-top:20px;">
      <h3>Add/Edit Plan</h3>
      <input id="pid" placeholder="ID (e.g. mtn-1gb)">
      <div style="display:flex; gap:10px">
        <select id="pnet"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option></select>
        <input id="papi" placeholder="Amigo Plan ID (e.g. 1001)">
      </div>
      <input id="pname" placeholder="Name (e.g. 1GB SME)">
      <input id="pprice" type="number" placeholder="Price">
      <button onclick="save()">Save Plan</button>
    </div>

    <table>
      <thead><tr><th>ID</th><th>Name</th><th>Price</th><th>API ID</th><th>Action</th></tr></thead>
      <tbody id="tbody-plans"></tbody>
    </table>
  </div>

  <!-- USERS VIEW -->
  <div id="view-users" style="display:none">
    <h3>Registered Users</h3>
    <table>
      <thead><tr><th>Phone</th><th>Balance</th><th>Account Details</th><th>Action</th></tr></thead>
      <tbody id="tbody-users"></tbody>
    </table>
  </div>
</div>

<script>
  const CRED = {u:'AbdallahSauki', p:'Abdallah@2025'};
  let auth = '';

  function login() {
    if(document.getElementById('u').value === CRED.u && document.getElementById('p').value === CRED.p) {
      auth = 'Basic ' + btoa(CRED.u + ':' + CRED.p);
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadPlans();
    } else alert('Invalid');
  }

  function switchTab(tab) {
    document.getElementById('view-plans').style.display = tab === 'plans' ? 'block' : 'none';
    document.getElementById('view-users').style.display = tab === 'users' ? 'block' : 'none';
    
    document.getElementById('tab-plans').classList.toggle('active', tab === 'plans');
    document.getElementById('tab-users').classList.toggle('active', tab === 'users');

    if(tab === 'users') loadUsers();
    else loadPlans();
  }

  // --- PLANS ---
  async function loadPlans() {
    const res = await fetch('/api/plans');
    const d = await res.json();
    document.getElementById('tbody-plans').innerHTML = d.map(x => `
      <tr>
        <td>${x.id}</td><td>${x.network} ${x.name}</td><td>₦${x.price}</td><td>${x.plan_id_api}</td>
        <td><button style="background:red; padding:5px" onclick="del('${x.id}')">Del</button></td>
      </tr>`).join('');
  }

  async function save() {
    const data = {
      action: 'create',
      id: document.getElementById('pid').value,
      network: document.getElementById('pnet').value,
      name: document.getElementById('pname').value,
      price: document.getElementById('pprice').value,
      plan_id_api: document.getElementById('papi').value
    };
    await fetch('/api/plans', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': auth}, body: JSON.stringify(data) });
    loadPlans(); alert('Saved');
  }

  async function del(id) {
    if(confirm('Delete?')) {
      await fetch('/api/plans', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': auth}, body: JSON.stringify({action:'delete', id}) });
      loadPlans();
    }
  }

  // --- USERS ---
  async function loadUsers() {
    const res = await fetch('/api/user', { headers: { 'Authorization': auth } });
    if(res.status !== 200) return alert("Failed to load users");
    
    const d = await res.json();
    document.getElementById('tbody-users').innerHTML = d.map(x => `
      <tr>
        <td>${x.phone_number}</td>
        <td style="font-weight:bold; color:green">₦${Number(x.wallet_balance).toLocaleString()}</td>
        <td style="font-size:12px">
            ${x.virtual_account_number || 'N/A'}<br>
            <span style="color:#888">${x.virtual_bank_name || ''}</span>
        </td>
        <td>
            <button class="fund-btn" onclick="fundUser('${x.phone_number}')">Fund Wallet</button>
        </td>
      </tr>`).join('');
  }

  async function fundUser(phone) {
    const amount = prompt(`Enter amount to fund for ${phone}:`);
    if(!amount) return;

    if(confirm(`Are you sure you want to add ₦${amount} to ${phone}?`)) {
        try {
            const res = await fetch('/api/user/fund', { // We will add this endpoint logic to user.js to support manual funding
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': auth},
                body: JSON.stringify({ phone, amount })
            });
            
            // If the endpoint doesn't exist yet, we will use a workaround or show error
            // NOTE: To make this work instantly without new files, I'll update user.js below to handle 'manual_fund' action
            const data = await res.json();
            if(data.success) {
                alert("Funded successfully!");
                loadUsers();
            } else {
                // Fallback to the main user endpoint if specific route fails
                manualFundFallback(phone, amount);
            }
        } catch(e) {
            manualFundFallback(phone, amount);
        }
    }
  }

  async function manualFundFallback(phone, amount) {
      // Use the generic POST /api/user with action 'fund'
      const res = await fetch('/api/user', {
          method: 'POST',
          headers: {'Content-Type':'application/json', 'Authorization': auth},
          body: JSON.stringify({ action: 'fund', phone, amount })
      });
      const data = await res.json();
      if(data.success) {
          alert("Funded Successfully!");
          loadUsers();
      } else {
          alert("Error: " + (data.error || "Could not fund"));
      }
  }
</script>
</body>
</html>


