<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sauki Admin Pro</title>
  <style>
    :root { --admin-bg: #1e1e2d; --admin-panel: #2b2b40; --accent: #3699ff; --text: #e1e1e6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--admin-bg); color: var(--text); margin: 0; padding: 20px; }
    
    .dashboard-grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
    @media(max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

    .sidebar { background: var(--admin-panel); padding: 20px; border-radius: 12px; height: fit-content; }
    .main { background: var(--admin-panel); padding: 30px; border-radius: 12px; min-height: 80vh; }

    h2, h3 { margin-top: 0; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    
    .stat-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
    .stat-val { font-size: 2rem; font-weight: bold; }
    
    input, select { width: 100%; padding: 12px; margin: 8px 0; background: #151521; border: 1px solid #444; color: #fff; border-radius: 6px; }
    
    button { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--accent); color: #fff; width: 100%; }
    .btn-danger { background: #f64e60; color: #fff; }
    .btn-retry { background: #FFA800; color: #000; padding: 6px 12px; font-size: 0.8rem; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
    th { text-align: left; padding: 15px; background: rgba(0,0,0,0.3); color: #888; }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase; }
    .s-success { background: rgba(29, 201, 183, 0.2); color: #1dc9b7; }
    .s-failed { background: rgba(253, 57, 122, 0.2); color: #fd397a; }

    #login-modal { position: fixed; inset: 0; background: var(--admin-bg); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .login-box { background: var(--admin-panel); padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div id="login-modal">
    <div class="login-box">
      <img src="logo.png" style="width:60px; margin-bottom:20px; border-radius:10px;" onerror="this.style.display='none'">
      <h2>Admin Login</h2>
      <input type="text" id="adm-u" placeholder="Admin Username">
      <input type="password" id="adm-p" placeholder="Password">
      <button class="btn-primary" onclick="adminLogin()">Access Dashboard</button>
    </div>
  </div>

  <div class="dashboard-grid" id="app-ui" style="display:none">
    <aside class="sidebar">
      <h3>Menu</h3>
      <button class="btn-primary" style="background:transparent; text-align:left" onclick="showTab('plans')">Manage Plans</button>
      <button class="btn-primary" style="background:transparent; text-align:left" onclick="showTab('tx')">Transactions</button>
      <div style="margin-top:40px; border-top:1px solid #444; padding-top:20px;">
        <button class="btn-danger" onclick="location.reload()">Logout</button>
      </div>
    </aside>

    <main class="main" id="tab-plans">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Data Plans</h2>
        <button class="btn-primary" style="width:auto" onclick="toggleEdit()">+ Add New Plan</button>
      </div>

      <div id="edit-form" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:8px; margin-bottom:20px; display:none;">
        <h4 style="margin-top:0">Plan Details</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="p-id" placeholder="ID (e.g. mtn-1gb)">
          <select id="p-net"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option></select>
          <input id="p-name" placeholder="Display Name (e.g. 1GB SME)">
          <input id="p-price" type="number" placeholder="Price (₦)">
          <input id="p-api" placeholder="Amigo/API Plan ID">
        </div>
        <button class="btn-primary" style="margin-top:10px;" onclick="savePlan()">Save Plan</button>
      </div>

      <table>
        <thead><tr><th>Network</th><th>Name</th><th>Price</th><th>API ID</th><th>Action</th></tr></thead>
        <tbody id="plans-table"></tbody>
      </table>
    </main>

    <main class="main" id="tab-tx" style="display:none">
      <div style="display:flex; justify-content:space-between;">
        <h2>Recent Transactions</h2>
        <button onclick="loadTx()" style="background:#444; color:#fff; padding:8px 15px; border-radius:6px; border:none">Refresh</button>
      </div>
      
      <table>
        <thead><tr><th>Time</th><th>Ref</th><th>Phone</th><th>Plan</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="tx-table"></tbody>
      </table>
    </main>
  </div>

  <script>
    let authHeader = '';

    async function adminLogin() {
      const u = document.getElementById('adm-u').value;
      const p = document.getElementById('adm-p').value;
      const creds = 'Basic ' + btoa(u + ':' + p);
      
      try {
        const res = await fetch('/api/admin?action=check', { headers: { 'Authorization': creds } });
        if(res.ok) {
          authHeader = creds;
          document.getElementById('login-modal').style.display = 'none';
          document.getElementById('app-ui').style.display = 'grid';
          loadPlans();
        } else {
          alert("Access Denied");
        }
      } catch(e) { alert("Connection Error"); }
    }

    function showTab(t) {
      document.getElementById('tab-plans').style.display = 'none';
      document.getElementById('tab-tx').style.display = 'none';
      document.getElementById('tab-' + t).style.display = 'block';
      if(t === 'tx') loadTx();
    }

    function toggleEdit() {
      const f = document.getElementById('edit-form');
      f.style.display = f.style.display === 'none' ? 'block' : 'none';
    }

    // --- PLANS ---
    async function loadPlans() {
      const res = await fetch('/api/plans');
      const data = await res.json();
      const rows = data.map(p => `
        <tr>
          <td style="text-transform:uppercase; font-weight:bold; color:var(--accent)">${p.network}</td>
          <td>${p.name}</td>
          <td>₦${p.price}</td>
          <td>${p.plan_id_api}</td>
          <td><button class="btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="deletePlan('${p.id}')">Remove</button></td>
        </tr>
      `).join('');
      document.getElementById('plans-table').innerHTML = rows;
    }

    async function savePlan() {
      const body = {
        action: 'create',
        id: document.getElementById('p-id').value,
        network: document.getElementById('p-net').value,
        name: document.getElementById('p-name').value,
        price: document.getElementById('p-price').value,
        plan_id_api: document.getElementById('p-api').value
      };
      
      await fetch('/api/plans', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
        body: JSON.stringify(body)
      });
      toggleEdit();
      loadPlans();
    }

    async function deletePlan(id) {
      if(!confirm("Are you sure?")) return;
      await fetch('/api/plans', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
        body: JSON.stringify({ action: 'delete', id })
      });
      loadPlans();
    }

    // --- TRANSACTIONS ---
    async function loadTx() {
      const res = await fetch('/api/admin?action=transactions', { headers: { 'Authorization': authHeader } });
      const data = await res.json();
      
      if(data.error) return alert(data.error);

      const rows = data.map(t => {
        const badge = t.status === 'success' ? 's-success' : 's-failed';
        let actionBtn = '';
        if(t.status !== 'success') {
           actionBtn = `<button class="btn-retry" onclick="retryTx(${t.id})">Retry ↺</button>`;
        }
        
        return `
          <tr>
            <td style="font-size:0.8rem; color:#888">${new Date(t.created_at).toLocaleString()}</td>
            <td style="font-family:monospace; font-size:0.8rem">${t.reference}</td>
            <td>${t.phone_number}</td>
            <td>${t.plan_id}</td>
            <td><span class="status-badge ${badge}">${t.status}</span></td>
            <td>${actionBtn}</td>
          </tr>
        `;
      }).join('');
      document.getElementById('tx-table').innerHTML = rows;
    }

    async function retryTx(id) {
        if(!confirm("Are you sure you want to retry this transaction?")) return;
        
        const btn = event.target;
        btn.innerText = "Processing...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
                body: JSON.stringify({ action: 'retry', id: id })
            });
            const data = await res.json();
            
            if(data.success) {
                alert("Success! Data sent.");
                loadTx();
            } else {
                alert("Failed: " + data.error);
                btn.innerText = "Retry ↺";
                btn.disabled = false;
            }
        } catch(e) {
            alert("Network Error");
            btn.innerText = "Retry ↺";
            btn.disabled = false;
        }
    }

  </script>
</body>
</html>


