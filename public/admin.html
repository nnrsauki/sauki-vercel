<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sauki Command Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000000;
      --sidebar-bg: #1c1c1e;
      --card-bg: #1c1c1e;
      --border-color: #38383a;
      --primary: #0A84FF;
      --success: #30D158;
      --danger: #FF453A;
      --warning: #FF9F0A;
      --text-main: #FFFFFF;
      --text-sec: #8E8E93;
      --radius: 12px;
    }
    
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    
    /* Login */
    #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
    .login-box { background: #1c1c1e; padding: 40px; border-radius: 24px; width: 350px; text-align: center; border: 1px solid var(--border-color); }
    .login-input { background: #2c2c2e; border: none; padding: 16px; width: 100%; color: white; border-radius: 12px; margin-bottom: 12px; font-size: 16px; outline: none; }
    
    /* Sidebar */
    .sidebar { width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; gap: 5px; }
    .nav-btn { padding: 12px 16px; border-radius: 8px; color: var(--text-sec); cursor: pointer; transition: 0.2s; font-weight: 500; display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-btn.active { background: var(--primary); color: white; }
    
    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    
    /* Cards & Tables */
    .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    h1 { font-size: 24px; font-weight: 700; margin: 0 0 20px 0; }
    
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; color: var(--text-sec); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
    td { padding: 14px 12px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    tr:last-child td { border-bottom: none; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-agent { background: rgba(10, 132, 255, 0.2); color: var(--primary); }
    .badge-web { background: rgba(255, 255, 255, 0.1); color: #fff; }
    .badge-manual { background: rgba(255, 159, 10, 0.2); color: var(--warning); }
    .badge-success { color: var(--success); }
    
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; transition:0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--danger); }
    .btn-glass { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border-color); }
    .btn:active { transform:scale(0.96); }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(180deg, #2c2c2e 0%, #1c1c1e 100%); padding: 24px; border-radius: 16px; border: 1px solid var(--border-color); }
    .stat-val { font-size: 32px; font-weight: 700; margin-top: 5px; color: white; }

    /* Inputs */
    .input-glass { background: #000; border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
    textarea.input-glass { resize: vertical; min-height: 100px; font-family: inherit; }
    label { font-size: 12px; color: var(--text-sec); display: block; margin-bottom: 5px; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .modal-box { background: #1c1c1e; padding: 30px; border-radius: 20px; border: 1px solid var(--border-color); width: 100%; max-width: 500px; }
  </style>
</head>
<body>

  <!-- AUTH SCREEN -->
  <div id="login-overlay">
    <div class="login-box">
      <h2 style="margin-bottom:20px">Admin Access</h2>
      <input type="text" id="adm-u" class="login-input" placeholder="Username">
      <input type="password" id="adm-p" class="login-input" placeholder="Password">
      <button class="btn btn-primary" style="width:100%; padding:14px" onclick="login()">Login</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div style="padding:15px; font-weight:800; font-size:18px;">SAUKI COMMAND</div>
    <div class="nav-btn active" onclick="nav('home')" id="nav-home">üìà Overview</div>
    <div class="nav-btn" onclick="nav('plans')" id="nav-plans">üè∑Ô∏è Plans & Prices</div>
    <div class="nav-btn" onclick="nav('agents')" id="nav-agents">üë• Resellers</div>
    <div class="nav-btn" onclick="nav('tx')" id="nav-tx">üßæ Transactions</div>
    <div class="nav-btn" onclick="nav('complaints')" id="nav-complaints">üí¨ Complaints</div>
    <div class="nav-btn" onclick="nav('broadcast')" id="nav-broadcast">üì¢ Broadcast</div>
    <div style="flex:1"></div>
    <div class="nav-btn" onclick="logout()" style="color:var(--danger)">Logout</div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    
    <!-- 1. OVERVIEW -->
    <div id="view-home">
      <h1>Dashboard Overview</h1>
      <div class="stats-row">
        <div class="stat-card">
          <div style="color:var(--text-sec)">Total Reseller Wallet Funds</div>
          <div class="stat-val" id="stat-wallet">‚Ç¶0.00</div>
        </div>
        <div class="stat-card">
          <div style="color:var(--text-sec)">Total Successful Sales</div>
          <div class="stat-val" id="stat-sales">‚Ç¶0.00</div>
        </div>
      </div>
      <div class="card">
         <h2 style="font-size:18px; margin-top:0">Quick Actions</h2>
         <button class="btn btn-primary" onclick="openManual()">+ Send Manual Order</button>
         <button class="btn btn-glass" onclick="nav('broadcast')">Update Broadcast</button>
      </div>
    </div>

    <!-- 2. PLANS & PRICING -->
    <div id="view-plans" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h1>Plans & Pricing</h1>
        <button class="btn btn-primary" onclick="openEditPlan()">+ Add New Plan</button>
      </div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Network</th>
              <th>Plan Name</th>
              <th>Standard Price</th>
              <th style="color:var(--primary)">Reseller Price</th>
              <th>API ID</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="plans-table"></tbody>
        </table>
      </div>
    </div>

    <!-- 3. AGENTS / RESELLERS -->
    <div id="view-agents" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h1>Reseller Accounts</h1>
        <input class="input-glass" style="width:250px; margin:0; background:#1c1c1e" id="search-agent" placeholder="Search Agent..." onchange="loadAgents()">
      </div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Full Name</th>
              <th>Phone Number</th>
              <th>Wallet Balance</th>
              <th>Virtual Account Details</th>
            </tr>
          </thead>
          <tbody id="agents-table"></tbody>
        </table>
      </div>
    </div>

    <!-- 4. TRANSACTIONS -->
    <div id="view-tx" style="display:none">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px">
        <h1>Transactions</h1>
        <div style="display:flex; gap:10px">
            <input class="input-glass" id="search-tx" placeholder="Search Phone/Ref" style="margin:0; width:200px">
            <button class="btn btn-glass" onclick="loadTx(true)">Search</button>
            <button class="btn btn-glass" onclick="exportCsv()">Export CSV</button>
            <button class="btn btn-primary" onclick="openManual()">+ Manual</button>
        </div>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Date</th><th>Ref</th><th>Target</th><th>Plan</th><th>Channel</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="tx-table"></tbody>
        </table>
      </div>
    </div>

    <!-- 5. COMPLAINTS -->
    <div id="view-complaints" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h1>User Complaints</h1>
            <button class="btn btn-glass" onclick="loadComplaints()">Refresh</button>
        </div>
        <div class="card">
            <table>
                <thead><tr><th>Date</th><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr></thead>
                <tbody id="complaints-table"></tbody>
            </table>
        </div>
    </div>

    <!-- 6. BROADCAST -->
    <div id="view-broadcast" style="display:none">
        <h1>System Broadcast</h1>
        <div class="card">
            <p style="color:var(--text-sec); margin-top:0">This message appears on the user's home screen. Leave empty to disable.</p>
            <textarea id="broadcast-input" class="input-glass" placeholder="Type message here..."></textarea>
            <button class="btn btn-primary" onclick="saveMessage()">Update Message</button>
        </div>
    </div>

  </div>

  <!-- EDIT PLAN MODAL -->
  <div id="edit-modal" class="modal-overlay">
    <div class="modal-box">
      <h2 style="margin-top:0">Manage Plan</h2>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
        <div><label>Plan ID</label><input id="p-id" class="input-glass"></div>
        <div><label>Network</label><select id="p-net" class="input-glass" style="height:45px"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option><option value="9mobile">9mobile</option></select></div>
        <div style="grid-column: span 2"><label>Display Name</label><input id="p-name" class="input-glass"></div>
        <div><label>User Price (‚Ç¶)</label><input id="p-price" class="input-glass" type="number"></div>
        <div><label style="color:var(--primary)">Reseller Price (‚Ç¶)</label><input id="p-res-price" class="input-glass" type="number" style="border-color:var(--primary)"></div>
        <div style="grid-column: span 2"><label>API Plan ID (Amigo)</label><input id="p-api" class="input-glass"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:20px">
        <button class="btn btn-primary" style="flex:1" onclick="savePlan()">Save Plan</button>
        <button class="btn btn-glass" onclick="document.getElementById('edit-modal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- MANUAL ORDER MODAL -->
  <div id="manual-modal" class="modal-overlay">
    <div class="modal-box">
      <h2 style="margin-top:0">Send Manual Order</h2>
      <label>Phone Number</label>
      <input id="m-phone" class="input-glass" placeholder="080...">
      <label>Network</label>
      <select id="m-net" class="input-glass" style="height:45px" onchange="updateManualPlans()"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option><option value="9mobile">9mobile</option></select>
      <label>Plan</label>
      <select id="m-plan" class="input-glass" style="height:45px"><option>Select Network First</option></select>
      
      <div style="display:flex; gap:10px; margin-top:20px">
        <button class="btn btn-success" style="flex:1" onclick="sendManual()">Send Data</button>
        <button class="btn btn-glass" onclick="document.getElementById('manual-modal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let auth = '';
    let allPlans = [];
    let currentTxData = [];

    function login() {
        const u = document.getElementById('adm-u').value;
        const p = document.getElementById('adm-p').value;
        auth = 'Basic ' + btoa(u + ':' + p);
        fetch('/api/admin?action=check', { headers: { 'Authorization': auth } })
        .then(r => { 
            if(r.ok) { 
                document.getElementById('login-overlay').style.display = 'none'; 
                init(); 
            } else alert("Invalid Login"); 
        }).catch(() => alert("Connection Error"));
    }
    
    function logout() { location.reload(); }

    function nav(tab) {
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(`nav-${tab}`).classList.add('active');
        ['home','plans','agents','tx','complaints','broadcast'].forEach(t => document.getElementById(`view-${t}`).style.display = 'none');
        document.getElementById(`view-${tab}`).style.display = 'block';
        if(tab==='tx') loadTx();
        if(tab==='complaints') loadComplaints();
        if(tab==='broadcast') loadMessage();
    }

    function init() { loadStats(); loadPlans(); loadAgents(); loadTx(); }

    async function api(url, method='GET', body) {
        const opts = { method, headers: { 'Authorization': auth, 'Content-Type': 'application/json' } };
        if(body) opts.body = JSON.stringify(body);
        return fetch(url, opts).then(r => r.json());
    }

    // --- LOADERS ---
    async function loadStats() {
        const d = await api('/api/admin?action=stats');
        document.getElementById('stat-wallet').innerText = '‚Ç¶' + (d.agent_wallet_balance || '0.00');
        document.getElementById('stat-sales').innerText = '‚Ç¶' + (d.total_sales || '0.00');
    }

    async function loadPlans() {
        allPlans = await fetch('/api/plans').then(r => r.json());
        document.getElementById('plans-table').innerHTML = allPlans.map(p => `
            <tr>
                <td style="text-transform:uppercase; font-weight:bold">${p.network}</td>
                <td>${p.name}</td>
                <td>‚Ç¶${p.price}</td>
                <td style="color:var(--primary); font-weight:bold">‚Ç¶${p.reseller_price || p.price}</td>
                <td style="font-family:monospace; color:#666">${p.plan_id_api}</td>
                <td>
                    <button class="btn btn-glass" style="padding:4px 10px" onclick='openEditPlan(${JSON.stringify(p)})'>Edit</button>
                    <button class="btn btn-danger" style="padding:4px 10px" onclick="delPlan('${p.id}')">Del</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadAgents() {
        const q = document.getElementById('search-agent').value;
        let url = '/api/admin?action=agents';
        if(q) url += `&search=${q}`;
        const d = await api(url);
        document.getElementById('agents-table').innerHTML = d.map(a => `
            <tr>
                <td>${a.full_name}</td>
                <td>${a.phone_number}</td>
                <td style="font-weight:bold">‚Ç¶${a.wallet_balance}</td>
                <td>
                    <div style="font-size:12px; color:#888">${a.virtual_account_bank}</div>
                    <div style="font-family:monospace">${a.virtual_account_number}</div>
                </td>
            </tr>
        `).join('');
    }

    async function loadTx(isSearch=false) {
        let url = '/api/admin?action=transactions';
        if(isSearch) {
             const q = document.getElementById('search-tx').value;
             if(q) url += `&search=${q}`;
        }
        const d = await api(url);
        currentTxData = d;
        document.getElementById('tx-table').innerHTML = d.map(t => {
            let badge = 'badge-web';
            if(t.channel === 'agent') badge = 'badge-agent';
            if(t.channel === 'manual') badge = 'badge-manual';
            
            return `<tr>
                <td style="font-size:12px; color:#666">${new Date(t.created_at).toLocaleString()}</td>
                <td style="font-family:monospace">${t.reference}</td>
                <td>${t.phone_number}</td>
                <td>${t.plan_id}</td>
                <td><span class="badge ${badge}">${t.channel || 'web'}</span></td>
                <td class="${t.status === 'success' ? 'badge-success' : 'btn-danger'}" style="${t.status !== 'success'?'background:none;color:#ff453a':''}">${t.status}</td>
                <td>${t.status !== 'success' ? `<button class="btn btn-glass" style="color:var(--warning)" onclick="retryTx('${t.id}')">Retry ‚Ü∫</button>` : '-'}</td>
            </tr>`;
        }).join('');
    }

    async function loadComplaints() {
        const d = await api('/api/admin?action=complaints');
        document.getElementById('complaints-table').innerHTML = d.length ? d.map(c => `
            <tr>
                <td style="font-size:12px; color:#666">${new Date(c.created_at).toLocaleString()}</td>
                <td>${c.name || 'Anon'}</td>
                <td>${c.phone}</td>
                <td style="font-size:13px; max-width:250px">${c.message}</td>
                <td><button class="btn btn-danger" style="padding:4px 10px" onclick="delComplaint('${c.id}')">Resolve</button></td>
            </tr>
        `).join('') : '<tr><td colspan="5" style="text-align:center; padding:20px; color:#666">No complaints found</td></tr>';
    }
    
    async function loadMessage() {
        const r = await fetch('/api/status').then(res=>res.json());
        if(r.message) document.getElementById('broadcast-input').value = r.message;
    }

    // --- ACTIONS ---
    function openEditPlan(p) {
        document.getElementById('edit-modal').style.display = 'flex';
        if(p) {
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-net').value = p.network;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-res-price').value = p.reseller_price;
            document.getElementById('p-api').value = p.plan_id_api;
        } else {
             document.getElementById('p-id').value = '';
             document.getElementById('p-name').value = '';
             document.getElementById('p-price').value = '';
             document.getElementById('p-res-price').value = '';
             document.getElementById('p-api').value = '';
        }
    }

    async function savePlan() {
        const body = {
            action: 'create',
            id: document.getElementById('p-id').value,
            network: document.getElementById('p-net').value,
            name: document.getElementById('p-name').value,
            price: document.getElementById('p-price').value,
            reseller_price: document.getElementById('p-res-price').value,
            plan_id_api: document.getElementById('p-api').value
        };
        await api('/api/plans', 'POST', body);
        document.getElementById('edit-modal').style.display = 'none';
        loadPlans();
    }

    async function delPlan(id) { if(confirm("Delete plan?")) { await api('/api/plans', 'POST', { action: 'delete', id }); loadPlans(); } }
    
    async function retryTx(id) {
        if(!confirm("Retry this transaction?")) return;
        const res = await api('/api/admin', 'POST', { action: 'retry', id });
        alert(res.success ? "Success" : "Failed: " + res.error);
        loadTx();
    }
    
    async function delComplaint(id) { if(confirm("Resolve complaint?")) { await api('/api/admin', 'POST', { action: 'delete_complaint', id }); loadComplaints(); } }
    
    async function saveMessage() {
        const msg = document.getElementById('broadcast-input').value;
        await api('/api/admin', 'POST', { action: 'save_message', message: msg });
        alert("Broadcast Updated");
    }

    // --- MANUAL ORDERS ---
    function openManual() { document.getElementById('manual-modal').style.display = 'flex'; updateManualPlans(); }
    
    function updateManualPlans() {
        const net = document.getElementById('m-net').value;
        const f = allPlans.filter(p => p.network === net);
        document.getElementById('m-plan').innerHTML = f.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    
    async function sendManual() {
        const phone = document.getElementById('m-phone').value;
        const net = document.getElementById('m-net').value;
        const planId = document.getElementById('m-plan').value;
        if(!phone || !planId) return alert("Fill all fields");
        if(!confirm(`Send ${net} data to ${phone}?`)) return;
        
        const res = await api('/api/admin', 'POST', { action: 'manual', phone, network: net, plan_id: planId });
        alert(res.success ? "Sent!" : "Failed: " + res.error);
        if(res.success) { document.getElementById('manual-modal').style.display='none'; loadTx(); }
    }
    
    function exportCsv() {
        if(!currentTxData.length) return alert("No data");
        let csv = "Date,Ref,Phone,Plan,Status,Channel\n" + currentTxData.map(t => `${t.created_at},${t.reference},${t.phone_number},${t.plan_id},${t.status},${t.channel}`).join('\n');
        const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        const a = document.createElement('a'); a.href=url; a.download='transactions.csv'; a.click();
    }
  </script>
</body>
</html>
