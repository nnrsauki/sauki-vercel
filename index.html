<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sauki Data Links</title>
  
  <!-- 1. FLUTTERWAVE SCRIPT (Must be here) -->
  <script src=""></script>
  
  <style>
    /* iOS Design System */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root { 
      --bg-body: #F2F2F7; 
      --bg-app: #ffffff; 
      --text-main: #1C1C1E; 
      --text-sub: #8E8E93;
      --accent: #007AFF; 
      --green: #34C759; 
      --border: #E5E5EA;
      --radius: 20px;
      --max-width: 960px;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      min-height: 100vh;
      display: flex; justify-content: center;
    }

    .app-wrapper {
      width: 100%; max-width: var(--max-width);
      background: var(--bg-app);
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 50px rgba(0,0,0,0.05);
      display: flex; flex-direction: column;
    }

    /* Navbar */
    .navbar { 
      position: sticky; top: 0; height: 70px; 
      background: rgba(255,255,255,0.95); 
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border); 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 0 16px; z-index: 1000; 
    }
    .nav-logo { font-weight: 700; font-size: 1.1rem; color: #000; text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .nav-logo img { width: 32px; height: 32px; border-radius: 8px; }
    .nav-right { display: flex; gap: 16px; }
    .nav-item { display: flex; flex-direction: column; align-items: center; border: none; background: none; cursor: pointer; color: var(--accent); gap: 2px; }
    .nav-item svg { width: 22px; height: 22px; }
    .nav-item span { font-size: 0.65rem; font-weight: 600; }

    /* Content */
    .main-content { flex: 1; padding: 20px; }
    .hero { text-align: center; margin: 20px 0 30px; }
    .hero h1 { font-size: 1.8rem; margin-bottom: 5px; }
    
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    @media (max-width: 768px) { .cards-grid { grid-template-columns: 1fr; } }

    .card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; text-align: left; cursor: pointer; min-height: 130px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); transition: 0.2s; }
    .card:active { transform: scale(0.97); background: #f9f9f9; }
    .card-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 14px; }
    
    /* Footer */
    .footer { text-align: center; padding: 40px 20px; border-top: 1px solid var(--border); background: #FAFAFA; font-size: 0.8rem; color: var(--text-sub); margin-top: auto; }
    .heart { color: #FF3B30; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    .modal-sheet { background: #fff; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .sheet-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 10; }
    .sheet-body { padding: 24px; }
    
    .input { width: 100%; padding: 14px; background: #F2F2F7; border: 1px solid transparent; border-radius: 14px; font-size: 1rem; margin-bottom: 15px; outline: none; }
    .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; color: #fff; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn-green { background: var(--green); }
    .btn-accent { background: var(--accent); }

    /* Loading */
    .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-view { text-align: center; padding: 40px 20px; }
    
    .list-item { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  </style>
</head>
<body class="is-home">

<div class="app-wrapper">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <a href="#" class="nav-logo" onclick="window.location.reload()">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <span>Sauki Data</span>
      </a>
    </div>
    <div class="nav-right">
      <button class="nav-item" onclick="openGiveaway()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg><span>Win</span></button>
      <button class="nav-item" onclick="subscribe()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Alerts</span></button>
      <button class="nav-item" onclick="openContact()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg><span>Help</span></button>
    </div>
  </nav>

  <div class="main-content">
    <div class="hero">
      <h1>Buy Cheap Data</h1>
      <p style="color:#8E8E93">Automated Instant Delivery</p>
    </div>

    <!-- Networks -->
    <div class="cards-grid">
      <div class="card" onclick="fetchPlans('mtn')">
        <div class="card-icon" style="background:#FFF9C4; color:#FBC02D;"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div>
        <h3 style="font-weight:600">MTN Data</h3>
        <p style="color:#8E8E93">SME & Corporate</p>
      </div>
      <div class="card" onclick="fetchPlans('glo')">
        <div class="card-icon" style="background:#E8F5E9; color:#43A047;"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
        <h3 style="font-weight:600">Glo Data</h3>
        <p style="color:#8E8E93">Best Value</p>
      </div>
      <div class="card" onclick="fetchPlans('airtel')">
        <div class="card-icon" style="background:#FFEBEE; color:#D32F2F;"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
        <h3 style="font-weight:600">Airtel Data</h3>
        <p style="color:#8E8E93">Manual Processing</p>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Sauki Data Links.</p>
    <p>With <span class="heart">‚ù§Ô∏è</span> from Abdallah Nangere</p>
  </footer>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-sheet">
    <div class="sheet-header">
      <span style="font-weight:600" id="modal-title">Title</span>
      <button onclick="closeModal()" style="border:none; background:none; font-size:16px; color:#007AFF; font-weight:600">Close</button>
    </div>
    <div class="sheet-body" id="modal-body"></div>
  </div>
</div>

<script>
  // 2. CONFIGURATION
  // ============================================
  // Using the exact key you provided:
  const FLW_PUBLIC_KEY = "FLWPUBK-ab3c49ed8e4056a8762fb6c6fbb68a83-X";
  const ADMIN_WHATSAPP = "2348164135836";
  const ADMIN_EMAIL = "saukidatalinks@gmail.com";
  // ============================================

  let selected = {};

  // --- PLANS ---
  async function fetchPlans(network) {
    openModal("Loading...", `<div class="loading-view"><div class="spinner"></div><h3>Fetching Plans...</h3></div>`);
    
    try {
      const res = await fetch(`/api/plans?network=${network}`);
      const plans = await res.json();
      
      if(plans.length === 0) {
        openModal(network.toUpperCase(), `<p style="text-align:center; padding:20px; color:#666">No plans available.</p>`);
        return;
      }

      const listHTML = plans.map(p => `
        <div class="list-item" onclick="selectPlan('${p.id}', ${p.price}, '${p.name}', '${network}')">
          <span style="font-weight:500">${p.name}</span>
          <span style="font-weight:600; color:#007AFF;">‚Ç¶${p.price}</span>
        </div>
      `).join('');
      
      openModal(network.toUpperCase() + " Plans", listHTML);
    } catch(e) {
      openModal("Error", `<p style="text-align:center; padding:20px; color:red">Connection Failed</p>`);
    }
  }

  function selectPlan(id, price, name, network) {
    selected = { id, price, name, network };
    const formHTML = `
      <div style="text-align:center; margin-bottom:20px;">
        <h2 style="margin:0;">‚Ç¶${price}</h2>
        <p style="color:#888;">${network.toUpperCase()} ${name}</p>
      </div>
      <label style="font-size:13px; color:#666; margin-left:5px">Your Name</label>
      <input class="input" id="c-name" placeholder="e.g. Abdallah">
      <label style="font-size:13px; color:#666; margin-left:5px">Beneficiary Phone</label>
      <input class="input" type="tel" id="c-phone" placeholder="e.g. 08012345678">
      <div style="display:flex; align-items:center; gap:10px; margin:10px 0 20px;">
        <input type="checkbox" id="c-ported" style="width:20px; height:20px">
        <label for="c-ported">Ported Number?</label>
      </div>
      <button class="btn btn-green" onclick="payNow()">Secure Pay</button>
    `;
    openModal("Confirm Order", formHTML);
  }

  // --- PAYMENT LOGIC ---
  function payNow() {
    const name = document.getElementById('c-name').value;
    const phone = document.getElementById('c-phone').value;
    const ported = document.getElementById('c-ported').checked;

    if(!name || !phone) return alert("Please fill all fields");

    // Clean Phone
    let cleanPhone = phone.replace(/[^0-9]/g, '');
    if (cleanPhone.startsWith("0")) cleanPhone = cleanPhone.substring(1);
    if (cleanPhone.startsWith("234")) cleanPhone = cleanPhone.substring(3);
    const standardPhone = "0" + cleanPhone;

    selected.phone = standardPhone;
    selected.name = name;
    selected.ported = ported;

    // Show Loading
    openModal("Processing", `
      <div class="loading-view">
        <div class="spinner"></div>
        <h3>Redirecting...</h3>
        <p style="color:#888; font-size:14px;">Do not close this window.</p>
      </div>
    `);

    if(selected.network === 'airtel') {
        setTimeout(() => window.location.href = `${ADMIN_WHATSAPP}?text=Buy Airtel Manual`, 1500);
        return;
      }

    // 3. FLUTTERWAVE CONFIGURATION
    try {
      FlutterwaveCheckout({
        public_key: FLW_PUBLIC_KEY,
        // AMENDED: tx_ref now includes phone number
        tx_ref: "SAUKI-" + selected.phone + "-" + Date.now(),
        amount: selected.price,
        currency: "NGN",
        payment_options: "banktransfer,ussd",
        customer: {
          email: "saukidatalinks@gmail.com",
          phone_number: selected.phone,
          name: selected.name,
        },
        customizations: {
          title: "Abdullahi Adam Usman",
          description: `Payment for ${selected.name}`,
          logo: "",
        },
        callback: function (data) {
          verifyOrder(data.transaction_id);
        },
        onclose: function() {
          closeModal(); // Close loading screen if user cancels
        }
      });
    } catch (err) {
      alert("Payment Error: " + err.message);
      closeModal();
    }
  }

  // --- VERIFY ---
  async function verifyOrder(txId) {
    document.getElementById('modal-body').innerHTML = `<div class="loading-view"><div class="spinner"></div><h3>Verifying...</h3><p>Dispensing Data...</p></div>`;
    
    try {
      const res = await fetch('/api/purchase', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          transaction_id: txId,
          plan_id: selected.id,
          mobile_number: selected.phone,
          network: selected.network,
          ported: selected.ported
        })
      });
      const data = await res.json();
      
      // AMENDED: Updated success message
      let html = data.success 
        ? `<div style="text-align:center; padding:30px;">
             <h2 style="color:#34C759; margin-bottom:15px;">Success!</h2>
             <p style="font-size:1.1rem; line-height:1.4; color:#333;">Thank You for Patronising Sauki Data. Your Data have been Delivered. In an event of network error or failure, you will be manually credited by our customer services.</p>
             <button class="btn btn-green" style="margin-top:20px" onclick="closeModal()">Done</button>
           </div>`
        : `<div style="text-align:center; padding:30px;"><h3 style="color:red">Failed</h3><p>${data.error}</p><button class="btn btn-accent" onclick="window.location.href='${ADMIN_WHATSAPP}'">Contact Support</button></div>`;
      
      openModal(data.success ? "Receipt" : "Error", html);
    } catch(e) {
      alert("Network Error"); closeModal();
    }
  }

  // --- ACTIONS ---
  function openGiveaway() {
    openModal("üéÅ Giveaway", `
      <div class="input"><label>Phone</label><input class="input" id="g-phone"></div>
      <div class="input"><label>Network</label><select class="input" id="g-net"><option>MTN</option><option>Glo</option></select></div>
      <div class="input"><label>Key</label><input class="input" id="g-key"></div>
      <button class="btn btn-accent" onclick="submitGiveaway()">Submit via WhatsApp</button>
    `);
  }

  function submitGiveaway() {
    const p = document.getElementById('g-phone').value;
    const k = document.getElementById('g-key').value;
    const n = document.getElementById('g-net').value;
    if(!p || !k) return alert("Fill all fields");
    window.open(`${ADMIN_WHATSAPP}?text=${encodeURIComponent(`Giveaway Entry:\nPhone: ${p}\nNetwork: ${n}\nKey: ${k}`)}`, '_blank');
  }

  function subscribe() { window.open(`${ADMIN_WHATSAPP}?text=Subscribe`, '_blank'); }
  
  // AMENDED: Contact Function with visible details
  function openContact() {
    openModal("Contact", `
      <div class="list-item" onclick="window.open('${ADMIN_WHATSAPP}', '_blank')">
        <div>
          <span style="display:block; font-weight:500">WhatsApp</span>
          <span style="display:block; font-size:13px; color:#8E8E93">+${ADMIN_WHATSAPP}</span>
        </div>
        <span style="color:#007AFF; font-weight:600">Chat</span>
      </div>
      <div class="list-item" onclick="window.location.href='mailto:${ADMIN_EMAIL}'">
        <div>
          <span style="display:block; font-weight:500">Email</span>
          <span style="display:block; font-size:13px; color:#8E8E93">${ADMIN_EMAIL}</span>
        </div>
        <span style="color:#007AFF; font-weight:600">Send</span>
      </div>
    `);
  }

  // --- MODAL ---
  function openModal(title, html) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-body').innerHTML = html;
    document.querySelector('.modal-overlay').classList.add('active');
  }
  function closeModal() {
    document.querySelector('.modal-overlay').classList.remove('active');
  }
</script>
</body>
</html>